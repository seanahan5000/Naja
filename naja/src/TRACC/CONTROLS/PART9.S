				DW	ELEVATOR		;0
				DW	ROTROOM			;1
				DW	SHIPSND			;2
				DW	GRAFITI			;3
				DW	NET				;4
				DW	QUICKD			;5
				DW	ESTATION		;6
				DW	VDOORS			;7
				DW	HDOORS			;8
				DW	CDFOUND			;9
				DW	ORBPED			;A
				DW	INFROOM			;B
				DW	ORBGRD			;C
				DW	AUTOEN			;D
				DW	NOENCNT			;E
				DB	$FF,$FF			;F
				DW	NOTDOOR			;10
				DW	FAKEFC			;11
				DB	$FF,$FF			;12
				DB	$FF,$FF			;13
				DB	$FF,$FF			;14
				DB	$FF,$FF			;15
				DW	ORB_DOOR		;16
				DW	NAJADOR			;17
				DW	FAKE2			;18

FACE1			DB	$42,$07,$01
				DB	$83,$08,$01
				DB	$26,$01,$07
				DB	$12,$12,$0F
FACE2			DB	$02,$03,$01
				DB	$83,$02,$01
				DB	$24,$07,$0B
				DB	$26,$06,$0B
				DB	$26,$07,$05
				DB	$12,$12,$FF
FACE3			DB	$41,$04,$00
				DB	$41,$05,$00
				DB	$C2,$03,$04
				DB	$42,$04,$04
				DB	$23,$06,$02
				DB	$23,$07,$02
				DB	$23,$08,$02
				DB	$23,$09,$02
				DB	$84,$02,$06
				DB	$24,$05,$02
				DB	$25,$05,$02
				DB	$26,$05,$02
				DB	$27,$06,$02
				DB	$27,$07,$02
				DB	$27,$08,$02
				DB	$27,$09,$02
				DB	$12,$12,$FF
FACE4			DB	$22,$01,$0E
				DB	$22,$02,$0D
				DB	$22,$04,$0D
				DB	$22,$06,$0D
				DB	$22,$08,$0D
				DB	$22,$09,$0E
				DB	$23,$01,$0D
				DB	$23,$09,$0D
				DB	$24,$01,$08
				DB	$24,$09,$08
				DB	$25,$01,$0D
				DB	$25,$04,$0E
				DB	$25,$06,$0E
				DB	$25,$09,$0D
				DB	$26,$05,$0C
				DB	$26,$07,$07
				DB	$28,$03,$10
				DB	$28,$05,$0A
				DB	$28,$07,$10
				DB	$12,$12,$FF
FACE5			DB	$01,$03,$03
				DB	$41,$03,$03
				DB	$81,$03,$03
				DB	$24,$08,$09
				DB	$C7,$02,$01
				DB	$08,$03,$01
				DB	$12,$12,$FF
FACE6			DB	$21,$04,$0E
				DB	$82,$05,$11		; fake face change
				DB	$26,$09,$07
				DB	$27,$04,$02
				DB	$27,$05,$02
				DB	$27,$06,$02
				DB	$28,$03,$02
				DB	$28,$07,$02
				DB	$29,$03,$02
				DB	$29,$07,$02
				DB	$12,$12,$FF
FACE7			DB	$87,$04,$17		; naja door
				DB	$89,$05,$16		; orb door
				DB	$C9,$05,$18		; fake face change 2
				DB	$12,$12,$FF

TEXTS			DW	CRITICAL_TEXT
				DW	RUNDOWN_TEXT
				DW	CURED_TEXT
				DW	CONTAG_TEXT

sOrbDoor		=	0

FILE_TABLE		DB	$90				;0 - sOrbDoor
				DW	$0180
				DB	$0D

LINER			TYA
				ASL
				TAY
				LDA	LINES,Y
				STA	POINTL
				LDA	LINES+1,Y
				STA	POINTH
				JMP	LINEOUT
LINES			DB	$FF,$FF
				DB	$FF,$FF
				DW	BLKLIN2
				DW	EBOX2
				DW	BLKLINE
				DW	EBOX

SHIPSND			NOP
GRAFITI			NOP
QUICKD			NOP
ESTATION		NOP
CDFOUND			NOP
INFROOM			NOP
ORBGRD			NOP
AUTOEN			NOP
NOENCNT			NOP
NAJADOR			NOP
				LDA	#$00
				RTS
*************
NOTDOOR
				LDA	#$C0
				STA	MOD4A+8
				STA	MOD4C+2
				LDA	MOD4B+4
				AND	#$FE
				STA	MOD4B+4
				LDA	#$00
				RTS
*************
ORBPED
				LDA	MOD4B+4
				ORA	#$01
				STA	MOD4B+4
				LDA	#$80
				STA	MOD4A+8
				STA	MOD4C+2
				LDA	#$00			;TEMP
				RTS					;TEMP
*************
VDOORS			LDX	#$00
				BEQ	VHCOMN
HDOORS			LDX	#$01
VHCOMN			LDA	V1,X
				STA	MOD4A+1
				STA	MOD4A+7
				STA	MOD4C+1
				STA	MOD4C+7
				LDA	V2,X
				STA	MOD4B+1
				STA	MOD4B+7
				LDA	V3,X
				STA	MOD4A+3
				STA	MOD4B+3
				STA	MOD4C+3
				LDA	V4,X
				STA	MOD4A+4
				STA	MOD4C+4
				LDA	V5,X
				STA	MOD4B+4
				JSR	GETNSEW
				LDA	#$00
				RTS
V1				DB	$F0,$30
V2				DB	$EF,$2F
V3				DB	$E0,$E3
V4				DB	$2C,$EC
V5				DB	$02,$C2
*************
ROTROOM			JSR	RNDMIZE
				LDA	RANDOM1
				AND	#$07
				CMP	#$06
				BCS	ROTROOM
				ASL
				ASL
				TAX
				LDA	ROTSPOT,X
				STA	XPOS
				LDA	ROTSPOT+1,X
				STA	YPOS
				LDA	ROTSPOT+2,X
				STA	DIRECTN
				LDA	ROTSPOT+3,X
				STA	FACE
				LDA	#$00
				RTS
ROTSPOT			DB	$03,$08,$F0,$01
				DB	$02,$07,$0F,$01
				DB	$03,$02,$F0,$02
				DB	$02,$03,$00,$02
				DB	$08,$03,$00,$05
				DB	$07,$02,$FF,$05
*************
NET				LDA	FLAG12
*****TEMP*****
				LDA	$BC80			; TODO: figure out what this is
				CMP	#$0C
				BNE	NOOPEN
				LDA	#$00
				RTS
NOOPEN			NOP
				LDA	FLAG12
*****TEMP*****
				CMP	#$02
				BNE	DONTSCAN
				JSR	SCANONE
				JMP	SCAN
DONTSCAN		JSR	HGR
				JSR	NOSCAN
SCAN			JSR	NETDRAW
WAVER1			BIT	UNSTROB
WAVER2			STA	PRIMARY
				LDA	#$04
				JSR	WAIT
				STA	SCNDARY
				LDA	#$04
				JSR	WAIT
				LDA	KEYBRD
				BPL	WAVER2
				JSR	CPARER2
				BNE	WAVER1
				JMP	RDKEY			; TODO: should RTS instead of jumping
NETDRAW			LDA	YPOS
				ORA	#$D0
				CMP	PICKON
				BEQ	NETOUT
				STA	PICKON
				JSR	MOVETO2
				LDA	#$0D
				STA	DATAPNT
				LDA	#$18
				STA	LINENUM
NETTER1			TAX
				LDA	LOBYTES,X
				STA	SCREENL
				LDA	HIBYTES,X
				ORA	#$40
				STA	SCREENH
				LDX	DATAPNT
				LDA	DATABYTE,X
				LDY	#$0A
NETTER2			STA	(SCREENL),Y
				EOR	EORTABLE,X
				INY
				CPY	#$1D
				BNE	NETTER2
				AND	#$BF
				STA	(SCREENL),Y
				DEC	DATAPNT
				BPL	NOMODULO
				LDA	#$0D
				STA	DATAPNT
NOMODULO		INC	LINENUM
				LDA	LINENUM
				CMP	#$B3
				BNE	NETTER1
NETOUT			RTS
DATABYTE		DB	$40,$88,$80
				DB	$10,$00,$A0
				DB	$80,$44,$84
				DB	$82,$00,$01
				DB	$80,$80
EORTABLE		DB	$48,$08,$10
				DB	$10,$20,$20
				DB	$40,$44,$04
				DB	$02,$02,$01
				DB	$01,$40
*************
ELEVATOR		LDA	#$40
				STA	PAGE
				JSR	CLEAR2
				JSR	NOSCAN
				LDA	#BLACK1
				STA	COLOR
				LDA	YPOS
				SEC
				SBC	#$03
				ASL
				TAY
				PHA
				JSR	LINER
				LDA	#WHITE1
				STA	COLOR
				PLA
				TAY
				INY
				JSR	LINER
				STA	SCNDARY
				JSR	MOVETO1
				STA	PRIMARY
				LDA	YPOS
				CMP	#$04
				BEQ	FARELEV
				JSR	SET_CAMPFILES
				LDA	CAMP_HERE
				AND	#bit_Diagnose!$FF				;! means XOR
				STA	CAMP_HERE
				LDX	#cElevator
				JSR	SLOAD_FILE
				LDA	#$01			;Elevator 345 flag
				JMP	$9000
FARELEV			BIT	UNSTROB
:LOOP1			LDA	KEYBRD
				BPL	:LOOP1
				JSR	CPARER1
				BNE	FARELEV
				JMP	RDKEY			; TODO: should RTS instead of jumping
*************
; Fake face change to get to orb door/core
;
FAKEFC			JSR	FAKER
				LDA	#$07
				STA	FACE
				LDA	#$09
				STA	XPOS
				JSR	GETNSEW
				JMP	ORB_DOOR

; Fake face change to get back from orb door/core
;
FAKE2			JSR	FAKER
				LDA	#$06
				STA	FACE
				LDA	#$02
				STA	XPOS
				JSR	GETNSEW
				JSR	CLEAR1
				JMP	NOSCAN			; implicit RTS

; Wait for forward keypress to cross fake face change
;
FAKER			LDA	FLAG12
				CMP	#$02
				BNE	GONOF
				JSR	SCANONE
				JMP	GOFAKE
GONOF			JSR	HGR
				JSR	NOSCAN
GOFAKE			BIT	KEYBRD
				BPL	GOFAKE
				LDA	KEYBRD
				JSR	CHECK_UP
				BEQ	GOFORWD
				JSR	CPARER2
				BEQ	GORDKEY
				BIT	UNSTROB
				JMP	GOFAKE
GORDKEY			PLA
				PLA
				LDA	#$FF			; read key before redrawing tunnel
				RTS
GOFORWD			BIT	UNSTROB
				RTS

; Orb door animation
;
ORB_DOOR		BIT	DOOR_OPEN
				BVS	:IS_OPEN

				; draw destination tunnel on page 2
				;	to be revealed by door animation
				;
				LDA	#$40
				STA	PAGE
				JSR	CLEAR2
				JSR	NOSCAN

				LDX	#sOrbDoor
				JSR	SLOAD_FILE
				JSR	$9000
				BCC	:NOT_OPENED
				LDA	#$FF
				STA	DOOR_OPEN
				BNE	:IS_OPEN		; always

:NOT_OPENED		JSR	TURN_AWAY
:IS_OPEN		LDA	#$FF			; read key before redrawing tunnel
				RTS

DOOR_OPEN		DB	$00				; TODO: should be stored someplace permanent

*************

; TODO: this should be part of COMMON.S
; TODO: reconcile with CPARER1, CPAPER2

RETURN_AWAY		BIT	UNSTROB
TURN_AWAY		LDA	KEYBRD
				BPL	TURN_AWAY
				JSR	CHECK_DOWN
				BEQ	:1
				JSR	CHECK_LEFT
				BEQ	:1
				JSR	CHECK_RIGHT
				BNE	RETURN_AWAY
:1				RTS

*************

SHELL9
			do ORIGINAL
F1				HEX	356A90
				HEX	E30C30
				HEX	0FFFF0
				HEX	F23020
				HEX	200FF0
				HEX	732230
				HEX	0BF000
				HEX	F02320
				HEX	038FF0
				HEX	CCCCD0
				HEX	3C3000
				HEX	C028D0
				HEX	3B03A0
				HEX	C33CD0
				HEX	003000
				HEX	C2C8D0
				HEX	000FA0
				HEX	C3E330
				HEX	3FD550

F2				HEX	3FD5F0
				HEX	C3F320
				HEX	000FB0
				HEX	C2C230
				HEX	003C00
				HEX	C33330
				HEX	3B00E0
				HEX	C02E30
				HEX	3C3000
				HEX	CCCF30
				HEX	038CE0
				HEX	703E30
				HEX	33F800
				HEX	FF8B30
				HEX	0CC0E0
				HEX	70CE30
				HEX	333C00
				HEX	4C0F30
				HEX	3FDDF0

F3				HEX	355BB0
				HEX	B33230
				HEX	0FB000
				HEX	FC3330
				HEX	0FFFB0
				HEX	F00030
				HEX	33FF00
				HEX	CC8330
				HEX	0003C0
				HEX	FCCCB0
				HEX	30FC00
				HEX	CF0CF0
				HEX	0F02C0
				HEX	E30CF0
				HEX	000000
				HEX	F30CF0
				HEX	0C00C0
				HEX	CF0F30
				HEX	37FF70

F4				HEX	1AA570
				HEX	EFFCF0
				HEX	0C02C0
				HEX	E3FCB0
MOD4A			HEX	0F3000
				HEX	E3ECF0
				HEX	0F3080
				HEX	E3FFF0
MOD4B			HEX	0F2F30
				HEX	E3C230
				HEX	3F2F30
				HEX	E3FFF0
MOD4C			HEX	0FF080
				HEX	E02C30
				HEX	0FF0F0
				HEX	E3FE20
				HEX	0C0000
				HEX	EFFF30
				HEX	1AA7F0

F5				HEX	3DFFF0
				HEX	C33C30
				HEX	0F0000
				HEX	F23830
				HEX	00F000
				HEX	F3CC30
				HEX	0B03B0
				HEX	F28030
				HEX	00F0F0
				HEX	E33330
				HEX	0E0B80
				HEX	F233D0
				HEX	00FC00
				HEX	F33FF0
				HEX	0B0330
				HEX	B23010
				HEX	00F330
				HEX	E0CC10
				HEX	1FF7F0

F6				HEX	3FDDF0
				HEX	C2F030
				HEX	000F30
				HEX	C30310
				HEX	00CF30
				HEX	C33020
				HEX	3F0CF0
				HEX	63CF30
				HEX	333E00
				HEX	D0E330
				HEX	3CC000
				HEX	CF3330
				HEX	3B0FF0
				HEX	C23030
				HEX	03E3C0
				HEX	CC0C90
				HEX	3C3FF0
				HEX	43C030
				HEX	3F6A90

F7				HEX	3FFFF0
				HEX	C00030
				HEX	000000
				HEX	C00030
				HEX	003F00
				HEX	C0C230
				HEX	000300
				HEX	C0CB30
				HEX	000CF0
				HEX	C0F010
				HEX	0000F0
				HEX	C0FF30
				HEX	000A00
				HEX	C0F330
				HEX	002F00
				HEX	C00030
				HEX	000000
				HEX	C00030
				HEX	3FFFF0
			else
F1				HEX	3FFDF0
				HEX	C3C230
				HEX	000FE0
				HEX	C2C8D0
				HEX	003000
				HEX	C33CD0
				HEX	3B03B0
				HEX	C02CB0
				HEX	3C3000
				HEX	4CCCF0
				HEX	238FE0
				HEX	703330
				HEX	0FF000
				HEX	732330
				HEX	300EF0
				HEX	623330
				HEX	0FF000
				HEX	623330
				HEX	355BB0

F2				HEX	3FD550
				HEX	C3F320
				HEX	000FF0
				HEX	C2C230
				HEX	003C00
				HEX	C33330
				HEX	3B00E0
				HEX	C02E30
				HEX	3C3000
				HEX	CCCF30
				HEX	038CE0
				HEX	703E30
				HEX	38F000
				HEX	CF0F30
				HEX	0CC0E0
				HEX	70CA30
				HEX	333000
				HEX	4C3F30
				HEX	3FDDF0

F3				HEX	355BB0
				HEX	B33230
				HEX	0FB000
				HEX	FC3330
				HEX	0FFFB0
				HEX	F00030
				HEX	33BF00
				HEX	CC8330
				HEX	3003C0
				HEX	FCCCB0
				HEX	00FC00
				HEX	CF0CF0
				HEX	0F02C0
				HEX	E30CF0
				HEX	000000
				HEX	F30CF0
				HEX	0C00C0
				HEX	CF0F30
				HEX	36FF70

F4				HEX	3FFD70
				HEX	C30CF0
				HEX	0B82C0
				HEX	F3CCB0
				HEX	0F3000
				HEX	E02CF0
				HEX	0F38C0
				HEX	E3CFF0
				HEX	0F3F30
				HEX	E00820
				HEX	3F3F30
				HEX	E3CFF0
				HEX	0F38C0
				HEX	E02C30
				HEX	0F30F0
				HEX	F3FE20
				HEX	0B8000
				HEX	C03F30
				HEX	3FF7F0

F5				HEX	3DFFF0
				HEX	C33C30
				HEX	0F0000
				HEX	F23830
				HEX	00F000
				HEX	F3CC30
				HEX	0B03B0
				HEX	F38030
				HEX	00F0F0
				HEX	E33330
				HEX	0E0EC0
				HEX	F230D0
				HEX	00F000
				HEX	F330F0
				HEX	0B0FF0
				HEX	B23210
				HEX	00F0F0
				HEX	E0CC10
				HEX	3FF7F0

F6				HEX	36FF70
				HEX	FF0CF0
				HEX	000080
				HEX	C30FF0
				HEX	0CFC00
				HEX	7C8F30
				HEX	00C0C0
				HEX	FFCCF0
				HEX	332F00
				HEX	40C3F0
				HEX	30F030
				HEX	CC3310
				HEX	2F0E30
				HEX	C3CF30
				HEX	000CC0
				HEX	C3F8F0
				HEX	001000
				HEX	C3FCF0
				HEX	3F7FF0

F7				HEX	3FFFF0
				HEX	C00030
				HEX	000000
				HEX	C00030
				HEX	003F00
				HEX	C0C230
				HEX	000300
				HEX	C0CB30
				HEX	000CF0
				HEX	C0F010
				HEX	0000F0
				HEX	C0FF30
				HEX	000A00
				HEX	C0F330
				HEX	002F00
				HEX	C00030
				HEX	000000
				HEX	C00030
				HEX	3FFFF0
			fin
