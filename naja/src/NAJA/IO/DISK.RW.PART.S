DESTL			EQU	$0D
DESTH			EQU	$0E
SSTOREL			EQU	$B1	
SSTOREH			EQU	$B2	
LAST1			EQU	$B3	
HOLDA			EQU	$26	
HOLDB			EQU	$27
MOTCNTL			EQU	$B6
MOTCNTH			EQU	$B7
HEDADD1			EQU	$50
HEDADD2			EQU	$51
HEDADD3			EQU	$52
HEDDAT1			EQU	$53
HEDDAT2			EQU	$54
HEDDAT3			EQU	$55
ECOUNT1			EQU	$56
ECOUNT2			EQU	$57
STRACK			EQU	$BA
SSECTOR			EQU	$BB
READNUM			EQU	$BC
CODETAB			EQU	$0700
BUFFER1			EQU	$BB00
BUFFER2			EQU	$BC00
READER			EQU	$C08C
DRIVEON			EQU	$C0E9
DRIVOFF			EQU	$C0E8
SYNC			EQU	$04	
SECOUNT			EQU	$05
SECTOR			EQU	$00
EOVALUE			EQU	$B0	
ARMOVE			EQU	$0E50	
DUMMY			EQU	$FF
				ORG	$0400	
WDATA			LDX	#$60
				SEC
				STX	HOLDB
				STX	HOLDC
				LDA	$C08D,X
				LDA	$C08E,X
				BMI	ERROR3
				LDA	BUFFER2
				STA	HOLDA
				LDA	SYNC
				STA	$C08F,X
				ORA	$C08C,X
				PHA
				PLA
				NOP
				LDY	#$04	
SYNCLOP			PHA
				PLA
				JSR	WRITEB
				DEY
				BNE	SYNCLOP
MODD1			LDA	#DUMMY	
				JSR	WRITEA
MODD2			LDA	#DUMMY	
				JSR	WRITEA
MODD3			LDA	#DUMMY	
				JSR	WRITEA
				TYA
				LDY	#$56
				BNE	SKIPS
SKIPA			LDA	BUFFER2,Y
SKIPS			EOR	BUFFER2-1,Y
				TAX
				LDA	DECODER,X
				LDX	HOLDB
				STA	$C08D,X
				LDA	$C08C,X	
				DEY
				BNE	SKIPA
				LDA	HOLDA
				NOP
MORBYTE			EOR	BUFFER1,Y
				TAX
				LDA	DECODER,X
				LDX	HOLDC
				STA	$C08D,X
				LDA	$C08C,X
				LDA	BUFFER1,Y
				INY
				BNE	MORBYTE
				EOR	EOVALUE
				TAX
				LDA	DECODER,X
				LDX	HOLDB
				LDX	HOLDB
				STA	$C08D,X
				ORA	$C08C,X
				NOP
				NOP
				NOP
				LDA	#$FE	
				JSR	WRITEA
				LDA	$C08E,X
				LDA	$C08C,X
				CLC
				RTS
ERROR3			SEC
				RTS
WRITEA			CLC
WRITEB			PHA
				PLA
				STA	$C08D,X
				ORA	$C08C,X
				RTS
**********END OF DATA WRITE*************
RADRESS			LDX	#$60
				LDY	#$F0	
				STY	HOLDA
ERRCHCK			INY
				BNE	LOOPX0
				INC	HOLDA
				BEQ	ERROR
LOOPX0			LDA	READER,X
				BPL	LOOPX0	
				CMP	SYNC	
				BNE	ERRCHCK	
LOOPX1			LDA	READER,X
				BPL	LOOPX1
				CMP	SYNC	
				BNE	ERRCHCK	
LOOPX2			LDA	READER,X
				BPL	LOOPX2
				CMP	SYNC	
				BEQ	LOOPX2	
				BNE	CHECKA
LOOPA			LDA	READER,X
				BPL	LOOPA
CHECKA			CMP	HEDADD1
				BNE	ERRCHCK	
				NOP
LOOPB			LDA	READER,X
				BPL	LOOPB
				CMP	HEDADD2
				BNE	CHECKA
				NOP	
LOOPC			LDA	READER,X
				BPL	LOOPC
				CMP	HEDADD3
				BNE	CHECKA
				LDA	#00
				STA	HOLDB
LOOPD			LDA	READER,X
				BPL	LOOPD
				ROL	A
				STA	HOLDA
LOOPE			LDA	READER,X
				BPL	LOOPE
				AND	HOLDA
				CMP	SECTOR	
				BNE	RADRESS
				CLC
				RTS
ERROR			SEC
				RTS
******************END OF READ ADDRESS***
RDATA			LDX	#$60
				LDY	#$20
ERRCNT			DEY
				BEQ	ERROR2
LOOP1			LDA	READER,X
				BPL	LOOP1
CHECK1			EOR	HEDDAT1	
				BNE	ERRCNT
				NOP
LOOP2			LDA	READER,X
				BPL	LOOP2
				CMP	HEDDAT2
				BNE	CHECK1
				LDY	#$56
LOOP3			LDA	READER,X
				BPL	LOOP3
				CMP	HEDDAT3
				BNE	CHECK1
				LDA	#$00
CHECK2			DEY
				STY	HOLDA
LOOP4			LDY	READER,X
				BPL	LOOP4
				EOR	CODETAB,Y
				LDY	HOLDA
				STA	BUFFER2,Y
				BNE	CHECK2
CHECK3			STY	HOLDA
LOOP5			LDY	READER,X
				BPL	LOOP5
				EOR	CODETAB,Y
				LDY	HOLDA
				STA	BUFFER1,Y
				INY
				BNE	CHECK3
LOOP6			LDY	READER,X
				BPL	LOOP6
				EOR	EOVALUE
				CMP	CODETAB,Y
				BNE	ERROR2
				CLC
				JMP	EXIT	
ERROR2			SEC
EXIT			RTS
****************END OF READ DATA********* 
NIBBLER			LDX	#$00
				LDY	#$02
NIBLOOP			DEY
				LDA	($3E),Y
				LSR	A
				ROL	BUFFER2,X
				LSR	A
				ROL	BUFFER2,X
				STA	BUFFER1,Y
				INX
				CPX	#$56
				BCC	NIBLOOP
				LDX	#$00
				TYA
				BNE	NIBLOOP
				LDX	#$55
ANDER			LDA	BUFFER2,X
				AND	#$3F
				STA	BUFFER2,X
				DEX
				BPL	ANDER
				RTS
DENIBLR			LDY	#$00
DNLOOP			LDX	#$56
DNLOOP2			DEX
				BMI	DNLOOP
				LDA	BUFFER1,Y
				LSR	BUFFER2,X
				ROL	A
				LSR	BUFFER2,X
				ROL	A
				STA	($3E),Y
				INY
				CPY	$26
				BNE	DNLOOP2
				RTS
EORTABL			DFB	$28,$36,$1D
				DFB	$1E,$0E,$3A
				DFB	$2F,$1C,$07
				DFB	$28,$00,$00
				DFB	$00,$00,$00
				DFB	$00
GETHEAD			LDA	TRACK
				LSR	A
				TAY
				LDX	ADD1,Y
				LDA	HEADS,X
				STA	HEDADD1	
				LDA	#$FF
				STA	HEDADD2	
				LDX	ADD3,Y
				LDA	HEADS,X
				STA	HEDADD3	
				LDA	ADD1,Y
				EOR	#$03
				TAX
				LDA	HEADS,X
				STA	HEDDAT1
				STA	MODD1+1
				LDA	#$FF
				STA	HEDDAT2
				STA	MODD2+1
				LDA	ADD3,Y
				EOR	#$03
				TAX
				LDA	HEADS,X
				STA	HEDDAT3
				STA	MODD3+1
				LDX	SYNCERS,Y
				LDA	SYNCS,X
				STA	SYNC	
				LDX	#$60
				RTS
HEADS			DFB	$00,$CD,$DC	
				DFB	$FF
SYNCS			DFB	$00,$FF,$FE	
				DFB	$AA	
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
ADD1			DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02,$02
				DFB	$02,$02
ADD3			DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01
SYNCERS			DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01,$01
				DFB	$01,$01
SREADIT			LDX	#$60
				LDA	DRIVEON
				LDA	#$D8
				STA	MOTCNTH
				LDA	$C08E,X
				LDA	$C08C,X
				LDY	#$08
TIMER			LDA	$C08C,X
				PHA
				PLA
				PHA
				PLA
				STX	HOLDC
				CMP	$C08C,X
				BNE	FREADIT	
				DEY
				BNE	TIMER
				LDY	MOTCNTH	
				BPL	FREADIT	
DEL12			LDY	#$12
DELSPED			DEY
				BNE	DELSPED
				INC	MOTCNTL
				BNE	DEL12
				INC	MOTCNTH
				BNE	DEL12
FREADIT			LDA	#$02
				STA	ECOUNT2
REDO2			LDA	STRACK
				ASL	A
				JSR	ARMOVE
				LDA	SSTOREL	
				STA	DESTL	
				LDA	SSTOREH	
				STA	DESTH	
				LDA	SSECTOR
				STA	SECTOR
				LDA	READNUM
				STA	SECOUNT
				JSR	GETHEAD
RLOOP			LDA	#$10
				STA	ECOUNT1
REDO			JSR	RADRESS
				BCS	GOTERR
				JSR	RDATA
				BCC	NOERR
GOTERR			DEC	ECOUNT1
				BNE	REDO
				DEC	ECOUNT2
* IGNORE ERROR COUNT 2
				LDA	#$88	
				STA	TRACK
				LDA	#$00
				JSR	ARMOVE
				JMP	REDO2
NOERR			LDA	DESTL	
				STA	$3E
				LDA	DESTH
				STA	$3F
				LDA	SECOUNT
				CMP	#$01
				BNE	NOTLAST
				LDA	LAST1
				JMP	GODENIB
NOTLAST			LDA	#$00
GODENIB			STA	$26
				JSR	DENIBLR
				INC	DESTH
				INC	SECTOR
				DEC	SECOUNT
				BEQ	READEND
				LDA	SECTOR
				CMP	#$10
				BNE	RLOOP
				LDA	#$00
				STA	SECTOR
				LDA	TRACK
				CLC
				ADC	#$02
				JSR	ARMOVE
				JSR	GETHEAD
				JMP	RLOOP
READEND			RTS
SREAD			JSR	SREADIT
				STA	DRIVOFF
				RTS
FREAD			LDX	#$60
				JMP	FREADIT
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
OPENBUF			DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF,$FF
				DFB	$FF,$FF	
HOLDC			DFB	$FF
TRACK			DFB	$3A
DECODER			DFB	$FF,$FE,$FD	
				DFB	$FC,$FB,$FA	
				DFB	$F9,$F7,$F6	
				DFB	$F5,$F4,$F3	
				DFB	$F2,$AF,$AE	
				DFB	$AD,$AC,$AB	
				DFB	$AA,$A7,$A6	
				DFB	$CF,$CE,$CB	
				DFB	$EF,$EE,$ED	
				DFB	$EC,$EB,$EA	
				DFB	$E9,$E7,$E6
				DFB	$E5,$DF,$DE	
				DFB	$DD,$DB,$DA	
				DFB	$D9,$D7,$D6	
				DFB	$D5,$D3,$BF	
				DFB	$BE,$BD,$BC
				DFB	$BB,$BA,$B9	
				DFB	$B7,$B6,$B5	
				DFB	$B4,$B3,$B2	
				DFB	$9F,$9E,$9D	
				DFB	$9B,$9A,$97	
				DFB	$96	
				DFB	$3F,$3E,$98
				DFB	$99,$3D,$3C	
				DFB	$9C,$3B,$3A	
				DFB	$39,$A0,$A1
				DFB	$A2,$A3,$A4
				DFB	$A5,$14,$13	
				DFB	$A8,$A9,$12	
				DFB	$11,$10,$0F	
				DFB	$0E,$0D,$B0
				DFB	$B1,$38,$37	
				DFB	$36,$35,$34	
				DFB	$33,$B8,$32	
				DFB	$31,$30,$2F	
				DFB	$2E,$2D,$2C	
				DFB	$C0,$C1,$C2
				DFB	$C3,$C4,$C5
				DFB	$C6,$C7,$C8
				DFB	$C9,$CA,$17	
				DFB	$CC,$CD,$16	
				DFB	$15,$D0,$D1
				DFB	$D2,$2B,$D4
				DFB	$2A,$29,$28	
				DFB	$D8,$27,$26	
				DFB	$25,$DC,$24	
				DFB	$23,$22,$E0
				DFB	$E1,$E2,$E3
				DFB	$E4,$21,$20	
				DFB	$1F,$E8,$1E	
				DFB	$1D,$1C,$1B	
				DFB	$1A,$19,$18	
				DFB	$F0,$F1,$0C	
				DFB	$0B,$0A,$09	
				DFB	$08,$07,$F8
				DFB	$06,$05,$04	
				DFB	$03,$02,$01	
				DFB	$00	
